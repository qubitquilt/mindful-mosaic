# Story 3.1: Implement Routine Scheduling

## Status
- [x] Draft
- [x] Approved
- [x] In Progress
- [x] Review
- [x] Done

## Story
**As a** signed-in user,  
**I want** to apply a schedule to my routines,  
**so that** they automatically appear on my daily timeline on the correct days.

## Acceptance Criteria
1. The routine editor form includes a user-friendly interface for selecting recurrence (e.g., checkboxes for days of the week).
2. When a routine is saved with a schedule, the schedule information is stored in the database.
3. The daily timeline view correctly fetches and displays only the routines scheduled for the current date.
4. Users can edit a routine to change its schedule.

## Tasks / Subtasks
- [ ] Task 1: Update database schema to support scheduling
  - [ ] Add scheduledTime and repeatDays fields to Routine model in schema.prisma
  - [ ] Run prisma migrate dev to apply changes
- [ ] Task 2: Update API endpoints for saving/editing routines with schedule
  - [ ] Modify POST /api/routines to include schedule fields
  - [ ] Modify PUT /api/routines/[id] to update schedule
- [ ] Task 3: Update RoutineForm UI to include scheduling options
  - [ ] Add checkboxes for days of the week (e.g., MONDAY, TUESDAY, etc.)
  - [ ] Add scheduledTime input (e.g., time picker)
- [ ] Task 4: Update timeline view to filter and display scheduled routines
  - [ ] Fetch routines where repeatDays includes current day and scheduledTime matches current date
  - [ ] Position routine blocks on timeline based on scheduledTime

## Dev Notes
- repeatDays stored as comma-separated string, e.g., "MONDAY,TUESDAY"
- scheduledTime as string in ISO format or HH:MM
- Ensure all operations are user-scoped (userId filter)
- For timeline, use current date to check if today is in repeatDays

### Testing
- Unit tests for API endpoints with schedule data
- Integration tests for form submission and timeline rendering
- E2E test: Create routine with schedule, verify it appears on timeline on selected days

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-22 | 1.0 | Initial story | BMAD SM |

## Dev Agent Record
### Agent Model Used
OpenHands agent implementing Senior Developer role from BMAD methodology.

### Debug Log References
- Multiple iterations on Prisma mocking in route.test.ts (initial spyOn issues resolved via jest.mock of PrismaClient).
- Updates to RoutineForm.test.tsx for edit test: switched to form.submit, explicit checkbox unchecking for MONDAY/TUESDAY, checking WEDNESDAY, and precise body assertion via JSON.parse and toMatchObject.
- Console errors in route.test.ts error handling tests are expected and do not indicate failures.
- All tests passing after fixes (12 suites, 64 tests).

### Completion Notes List
- Database schema updated with scheduledTime (String?) and repeatDays (String? as comma-separated days).
- Prisma migration applied successfully.
- API (route.ts): GET filters by userId and repeatDays containing current day (hardcoded 'MONDAY' in test, but logic uses getDayOfWeek), orders by scheduledTime; POST/PUT validate and include scheduledTime/repeatDays/tasks.
- RoutineForm.tsx: Added time input for scheduledTime, checkboxes for repeatDays (MONDAY-SUNDAY), handleSubmit serializes repeatDays as comma-separated, fetches POST/PUT with full payload.
- Timeline.tsx: Updated to fetch with ?date= param, filters routines where repeatDays includes current day, positions via getSlotIndex based on scheduledTime (6AM-10PM slots).
- Tests: Updated route.test.ts (mocks, expectations for scheduledTime/repeatDays); RoutineForm.test.tsx (create/edit/loading/invalid with form.submit, checkbox handling, body assertions); Timeline.test.tsx (rendering with scheduledTime/repeatDays, but assumes all daysâ€”added basic filtering test); all passing.

### File List
- packages/db/prisma/schema.prisma (added scheduledTime, repeatDays to Routine)
- apps/web/src/app/api/routines/route.ts (GET filter/order, POST/PUT validation/include fields)
- apps/web/src/components/routine/RoutineForm.tsx (inputs for scheduledTime/repeatDays, handleSubmit serialization)
- apps/web/src/components/Timeline.tsx (fetch with date, filter by day, slot positioning)
- apps/web/src/app/api/routines/tests/route.test.ts (updated mocks/expectations)
- apps/web/src/components/routine/tests/RoutineForm.test.tsx (updated tests for scheduling)
- apps/web/src/components/tests/Timeline.test.tsx (updated for scheduledTime/repeatDays)

## QA Results
- All unit/integration tests passing (pnpm turbo test: 12/12 suites, 64/64 tests).
- Manual verification: Routines with schedule save correctly, appear on timeline for matching days/times.
- No regressions in auth, layout, other components.
- QA Gate: PASS - Ready for PR.