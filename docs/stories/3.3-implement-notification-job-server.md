
# Story 3.3: Implement Notification Job Server

**Epic:** Epic 3: Scheduling & Execution  
**Story Goal:** As a user with a scheduled routine, I want to receive a notification when it's time to start, so that I don't forget to begin my planned tasks.  

**Acceptance Criteria:**  
1. The independent job server is built and can be run via Docker Compose alongside the web service.  
2. The job server can securely connect to and read from the application's database.  
3. The server periodically checks for routines that are scheduled to start soon (e.g., within the next 5 minutes).  
4. When an upcoming routine is found, a basic browser notification is successfully sent to the user.  
5. The job server is resilient and handles errors gracefully (e.g., database connection issues).  

**Tasks:**  
- [ ] Set up job server structure in apps/jobs (Node.js with Prisma client).  
- [ ] Implement database connection and routine query (filter by scheduledTime, repeatDays, current date/time).  
- [ ] Add polling logic (e.g., every minute) to check for upcoming routines (within 5 min threshold).  
- [ ] Integrate browser notification API (Web Push API or simple Notification if supported).  
- [ ] Handle user permissions for notifications (request permission if needed).  
- [ ] Add error handling, logging, and retries for DB/network issues.  
- [ ] Update docker-compose.yml to include jobs service with env vars (DATABASE_URL).  
- [ ] Add tests for job server (unit: query logic; integration: polling/notification).  
- [ ] Document job server setup/run in README.  

**Subtasks:**  
- Research Web Push API integration for self-hosted (service worker registration, VAPID keys).  
- Ensure notifications include routine name, start time, and link to timeline.  
- Test with sample routines (e.g., daily at specific time).  

**Development Notes:**  
- Use Node.js cron or setInterval for polling.  
- Shared Prisma client from packages/db.  
- Notifications: Use Notification API for simplicity (browser permission); fallback to console.log for testing.  
- Security: Env vars for DB; no auth needed for jobs as it reads own user's data via userId.  
- Edge cases: No upcoming routines, multiple routines, timezones (assume UTC/local).  

**Testing Plan:**  
- Unit: Mock Prisma, test query for upcoming routines.  
- Integration: Run job server, insert test routine, verify notification trigger.  
- E2E: Simulate time, check browser notification (manual).  
- Error: Mock DB failure, verify graceful handling.  

**Status:** Draft  
**Dev Agent Record:**  
- Debug Notes: N/A  
- Completion Notes: N/A  
- File List: N/A  
**QA Results:**  
- Tests: N/A  
- Manual Verification: N/A  
- Gate: N/A  

**Changelog:**  
- 2025-09-22: Initial draft based on PRD FR6/NFR4.
